import { Directive, EventEmitter, Inject, Input, Optional, Output } from '@angular/core';
import Sortable from 'sortablejs';
import { GLOBALS } from './globals';
import { SortablejsBindings } from './sortablejs-bindings';
import * as i0 from "@angular/core";
import * as i1 from "./sortablejs.service";
/** @internal */
const getIndexesFromEvent = (event) => {
    if (event.hasOwnProperty('newDraggableIndex') && event.hasOwnProperty('oldDraggableIndex')) {
        return {
            new: event.newDraggableIndex,
            old: event.oldDraggableIndex
        };
    }
    else {
        return {
            new: event.newIndex,
            old: event.oldIndex
        };
    }
};
export class SortablejsDirective {
    constructor(globalConfig, service, element, zone, renderer) {
        this.globalConfig = globalConfig;
        this.service = service;
        this.element = element;
        this.zone = zone;
        this.renderer = renderer;
        /** Initialised a new Sortablejs instance */
        this.init = new EventEmitter();
    }
    /** @internal */
    ngOnInit() {
        if (Sortable?.create) { // Sortable does not exist in angular universal (SSR)
            this.create();
        }
    }
    /** @internal */
    ngOnChanges(changes) {
        const optionsChange = changes.config;
        if (optionsChange && !optionsChange.isFirstChange()) {
            const previousOptions = optionsChange.previousValue;
            const currentOptions = optionsChange.currentValue;
            Object.keys(currentOptions).forEach(optionName => {
                if (currentOptions[optionName] !== previousOptions[optionName]) {
                    // use low-level option setter
                    this.sortableInstance?.option(optionName, this.options[optionName]);
                }
            });
        }
    }
    /** @internal */
    ngOnDestroy() {
        if (this.sortableInstance) {
            this.sortableInstance.destroy();
        }
    }
    create() {
        const container = this.sortablejsContainer ? this.element.nativeElement.querySelector(this.sortablejsContainer) : this.element.nativeElement;
        setTimeout(() => {
            this.sortableInstance = Sortable.create(container, this.options);
            this.init.emit(this.sortableInstance);
        }, 0);
    }
    getBindings() {
        if (!this.data) {
            return new SortablejsBindings([]);
        }
        else if (this.data instanceof SortablejsBindings) {
            return this.data;
        }
        else {
            return new SortablejsBindings([this.data]);
        }
    }
    get options() {
        return { ...this.optionsWithoutEvents, ...this.overridenOptions };
    }
    get optionsWithoutEvents() {
        return { ...(this.globalConfig || {}), ...(this.config || {}) };
    }
    proxyEvent(eventName, ...params) {
        this.zone.run(() => {
            if (this.optionsWithoutEvents?.[eventName]) {
                this.optionsWithoutEvents[eventName](...params);
            }
        });
    }
    get isCloning() {
        const groupOptions = this.sortableInstance?.options.group;
        return groupOptions && (typeof groupOptions != 'string')
            ? groupOptions.checkPull?.(this.sortableInstance, this.sortableInstance, null, null) === 'clone'
            : groupOptions === 'clone';
    }
    clone(item) {
        // by default pass the item through, no cloning performed
        return (this.cloneFunction || (subitem => subitem))(item);
    }
    get overridenOptions() {
        // always intercept standard events but act only in case items are set (bindingEnabled)
        // allows to forget about tracking this.items changes
        return {
            onAdd: (event) => {
                this.service.transfer = (items) => {
                    this.getBindings().injectIntoEvery(event.newIndex, items);
                    this.proxyEvent('onAdd', event);
                };
                this.proxyEvent('onAddOriginal', event);
            },
            onRemove: (event) => {
                const bindings = this.getBindings();
                if (bindings.provided) {
                    if (this.isCloning) {
                        this.service.transfer?.(bindings.getFromEvery(event.oldIndex).map(item => this.clone(item)));
                        // great thanks to https://github.com/tauu
                        // event.item is the original item from the source list which is moved to the target list
                        // event.clone is a clone of the original item and will be added to source list
                        // If bindings are provided, adding the item dom element to the target list causes artifacts
                        // as it interferes with the rendering performed by the angular template.
                        // Therefore we remove it immediately and also move the original item back to the source list.
                        // (event handler may be attached to the original item and not its clone, therefore keeping
                        // the original dom node, circumvents side effects )
                        this.renderer.removeChild(event.item.parentNode, event.item);
                        this.renderer.insertBefore(event.clone.parentNode, event.item, event.clone);
                        this.renderer.removeChild(event.clone.parentNode, event.clone);
                    }
                    else {
                        this.service.transfer?.(bindings.extractFromEvery(event.oldIndex));
                    }
                    this.service.transfer = undefined;
                }
                this.proxyEvent('onRemove', event);
            },
            onUpdate: (event) => {
                const bindings = this.getBindings();
                const indexes = getIndexesFromEvent(event);
                bindings.injectIntoEvery(indexes.new, bindings.extractFromEvery(indexes.old));
                this.proxyEvent('onUpdate', event);
            }
        };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: SortablejsDirective, deps: [{ token: GLOBALS, optional: true }, { token: i1.SortablejsService }, { token: i0.ElementRef }, { token: i0.NgZone }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "18.0.1", type: SortablejsDirective, selector: "[nxtSortablejs]", inputs: { data: ["nxtSortablejs", "data"], sortablejsContainer: "sortablejsContainer", config: "config", cloneFunction: "cloneFunction" }, outputs: { init: "init" }, usesOnChanges: true, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: SortablejsDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[nxtSortablejs]'
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GLOBALS]
                }] }, { type: i1.SortablejsService }, { type: i0.ElementRef }, { type: i0.NgZone }, { type: i0.Renderer2 }], propDecorators: { data: [{
                type: Input,
                args: ['nxtSortablejs']
            }], sortablejsContainer: [{
                type: Input
            }], config: [{
                type: Input
            }], cloneFunction: [{
                type: Input
            }], init: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydGFibGVqcy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wYWNrYWdlcy9zb3J0YWJsZWpzL3NyYy9saWIvc29ydGFibGVqcy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFFVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFLTCxRQUFRLEVBQ1IsTUFBTSxFQUdULE1BQU0sZUFBZSxDQUFBO0FBR3RCLE9BQU8sUUFBb0MsTUFBTSxZQUFZLENBQUE7QUFDN0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUNuQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTs7O0FBTTFELGdCQUFnQjtBQUNoQixNQUFNLG1CQUFtQixHQUFHLENBQUMsS0FBb0IsRUFBRSxFQUFFO0lBQ2pELElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDO1FBQ3pGLE9BQU87WUFDSCxHQUFHLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjtZQUM1QixHQUFHLEVBQUUsS0FBSyxDQUFDLGlCQUFpQjtTQUMvQixDQUFBO0lBQ0wsQ0FBQztTQUFNLENBQUM7UUFDSixPQUFPO1lBQ0gsR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ25CLEdBQUcsRUFBRSxLQUFLLENBQUMsUUFBUTtTQUN0QixDQUFBO0lBQ0wsQ0FBQztBQUNMLENBQUMsQ0FBQTtBQUtELE1BQU0sT0FBTyxtQkFBbUI7SUE0QjVCLFlBR3FCLFlBQWlDLEVBQ2pDLE9BQTBCLEVBQzFCLE9BQW1CLEVBQ25CLElBQVksRUFDWixRQUFtQjtRQUpuQixpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFDakMsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsWUFBTyxHQUFQLE9BQU8sQ0FB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QUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFFBQVMsQ0FBQyxDQUFDLENBQUE7b0JBQ3ZFLENBQUM7b0JBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFBO2dCQUNyQyxDQUFDO2dCQUVELElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3RDLENBQUM7WUFDRCxRQUFRLEVBQUUsQ0FBQyxLQUFvQixFQUFFLEVBQUU7Z0JBQy9CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtnQkFDbkMsTUFBTSxPQUFPLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBRTFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUksRUFBRSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEdBQUksQ0FBQyxDQUFDLENBQUE7Z0JBQy9FLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFBO1lBQ3RDLENBQUM7U0FDSixDQUFBO0lBQ0wsQ0FBQzs4R0FuS1EsbUJBQW1CLGtCQThCaEIsT0FBTztrR0E5QlYsbUJBQW1COzsyRkFBbkIsbUJBQW1CO2tCQUgvQixTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSxpQkFBaUI7aUJBQzlCOzswQkE4QlEsUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQyxPQUFPOytJQTFCbkIsSUFBSTtzQkFESCxLQUFLO3VCQUFDLGVBQWU7Z0JBVXRCLG1CQUFtQjtzQkFEbEIsS0FBSztnQkFLTixNQUFNO3NCQURMLEtBQUs7Z0JBS04sYUFBYTtzQkFEWixLQUFLO2dCQUlhLElBQUk7c0JBQXRCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgRGlyZWN0aXZlLFxyXG4gICAgRWxlbWVudFJlZixcclxuICAgIEV2ZW50RW1pdHRlcixcclxuICAgIEluamVjdCxcclxuICAgIElucHV0LFxyXG4gICAgTmdab25lLFxyXG4gICAgT25DaGFuZ2VzLFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgT25Jbml0LFxyXG4gICAgT3B0aW9uYWwsXHJcbiAgICBPdXRwdXQsXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBTaW1wbGVDaGFuZ2VcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJ1xyXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgaW1wb3J0L25vLWV4dHJhbmVvdXMtZGVwZW5kZW5jaWVzXHJcbmltcG9ydCB7IHR5cGUgQWJzdHJhY3RDb250cm9sLCB0eXBlIEZvcm1BcnJheSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJ1xyXG5pbXBvcnQgU29ydGFibGUsIHsgT3B0aW9ucywgU29ydGFibGVFdmVudCB9IGZyb20gJ3NvcnRhYmxlanMnXHJcbmltcG9ydCB7IEdMT0JBTFMgfSBmcm9tICcuL2dsb2JhbHMnXHJcbmltcG9ydCB7IFNvcnRhYmxlanNCaW5kaW5ncyB9IGZyb20gJy4vc29ydGFibGVqcy1iaW5kaW5ncydcclxuaW1wb3J0IHsgU29ydGFibGVqc1NlcnZpY2UgfSBmcm9tICcuL3NvcnRhYmxlanMuc2VydmljZSdcclxuXHJcbmV4cG9ydCB0eXBlIFNvcnRhYmxlRGF0YTxUPiA9IFQgZXh0ZW5kcyBBYnN0cmFjdENvbnRyb2wgPyAoRm9ybUFycmF5PFQ+IHwgVFtdKSA6IFRbXVxyXG5leHBvcnQgdHlwZSBDbG9uZUZ1bmN0aW9uPFQ+ID0gKGl0ZW06IFQpID0+IFRcclxuXHJcbi8qKiBAaW50ZXJuYWwgKi9cclxuY29uc3QgZ2V0SW5kZXhlc0Zyb21FdmVudCA9IChldmVudDogU29ydGFibGVFdmVudCkgPT4ge1xyXG4gICAgaWYgKGV2ZW50Lmhhc093blByb3BlcnR5KCduZXdEcmFnZ2FibGVJbmRleCcpICYmIGV2ZW50Lmhhc093blByb3BlcnR5KCdvbGREcmFnZ2FibGVJbmRleCcpKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbmV3OiBldmVudC5uZXdEcmFnZ2FibGVJbmRleCxcclxuICAgICAgICAgICAgb2xkOiBldmVudC5vbGREcmFnZ2FibGVJbmRleFxyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbmV3OiBldmVudC5uZXdJbmRleCxcclxuICAgICAgICAgICAgb2xkOiBldmVudC5vbGRJbmRleFxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tueHRTb3J0YWJsZWpzXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNvcnRhYmxlanNEaXJlY3RpdmU8VD4gaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuXHJcbiAgICAvKiogSW5wdXQgZGF0YSwgY2FuIGJlIEFycmF5IG9yIEZvcm1BcnJheSAqL1xyXG4gICAgQElucHV0KCdueHRTb3J0YWJsZWpzJylcclxuICAgIGRhdGE/OiBTb3J0YWJsZURhdGE8VD5cclxuXHJcbiAgICAvKipcclxuICAgICAqIENTUyBzZWxlY3RvciBmb3IgdGhlIHNvcnRhYmxlIGNvbnRhaW5lclxyXG4gICAgICpcclxuICAgICAqIE1vc3RseSByZXF1aXJlZCB3aGVuIHVzZWQgd2l0aCBjdXN0b20gY29tcG9uZW50cyB3aGljaCB3cmFwIGl0ZW1zIGluIG11bHRpcGxlIGNvbnRhaW5lcnMuIEluIHRoYXQgY2FzZSxcclxuICAgICAqIHRoaXMgc2hvdWxkIGJlIHRoZSBzZWxlY3RvciBmb3IgdGhlIGRpcmVjdCBIVE1MIHBhcmVudCBvZiBzb3J0YWJsZSBpdGVtcy5cclxuICAgICAqL1xyXG4gICAgQElucHV0KClcclxuICAgIHNvcnRhYmxlanNDb250YWluZXI/OiBzdHJpbmdcclxuXHJcbiAgICAvKiogU29ydGFibGVqcyBjb25maWd1cmF0aW9uICovXHJcbiAgICBASW5wdXQoKVxyXG4gICAgY29uZmlnPzogT3B0aW9uc1xyXG5cclxuICAgIC8qKiBBIGZ1bmN0aW9uIGludm9rZWQgd2hlbiBjbG9uaW5nIGl0ZW1zIGZyb20gdGVtcGxhdGUgZGF0YXNldCBpbnRvIHRhcmdldCBkYXRhc2V0ICovXHJcbiAgICBASW5wdXQoKVxyXG4gICAgY2xvbmVGdW5jdGlvbj86IENsb25lRnVuY3Rpb248VD5cclxuXHJcbiAgICAvKiogSW5pdGlhbGlzZWQgYSBuZXcgU29ydGFibGVqcyBpbnN0YW5jZSAqL1xyXG4gICAgQE91dHB1dCgpIHJlYWRvbmx5IGluaXQgPSBuZXcgRXZlbnRFbWl0dGVyPFNvcnRhYmxlPigpXHJcblxyXG4gICAgcHJpdmF0ZSBzb3J0YWJsZUluc3RhbmNlPzogU29ydGFibGVcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBAT3B0aW9uYWwoKVxyXG4gICAgICAgIEBJbmplY3QoR0xPQkFMUylcclxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGdsb2JhbENvbmZpZzogT3B0aW9ucyB8IHVuZGVmaW5lZCxcclxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHNlcnZpY2U6IFNvcnRhYmxlanNTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgZWxlbWVudDogRWxlbWVudFJlZixcclxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHpvbmU6IE5nWm9uZSxcclxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHJlbmRlcmVyOiBSZW5kZXJlcjJcclxuICAgICkgeyB9XHJcblxyXG4gICAgLyoqIEBpbnRlcm5hbCAqL1xyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgaWYgKFNvcnRhYmxlPy5jcmVhdGUhKSB7IC8vIFNvcnRhYmxlIGRvZXMgbm90IGV4aXN0IGluIGFuZ3VsYXIgdW5pdmVyc2FsIChTU1IpXHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlKClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIEBpbnRlcm5hbCAqL1xyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogeyBbcHJvcCBpbiBrZXlvZiBTb3J0YWJsZWpzRGlyZWN0aXZlPFQ+XTogU2ltcGxlQ2hhbmdlIH0pIHtcclxuICAgICAgICBjb25zdCBvcHRpb25zQ2hhbmdlID0gY2hhbmdlcy5jb25maWdcclxuXHJcbiAgICAgICAgaWYgKG9wdGlvbnNDaGFuZ2UgJiYgIW9wdGlvbnNDaGFuZ2UuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzT3B0aW9uczogT3B0aW9ucyA9IG9wdGlvbnNDaGFuZ2UucHJldmlvdXNWYWx1ZVxyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50T3B0aW9uczogT3B0aW9ucyA9IG9wdGlvbnNDaGFuZ2UuY3VycmVudFZhbHVlXHJcblxyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhjdXJyZW50T3B0aW9ucykuZm9yRWFjaChvcHRpb25OYW1lID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50T3B0aW9uc1tvcHRpb25OYW1lIGFzIGtleW9mIE9wdGlvbnNdICE9PSBwcmV2aW91c09wdGlvbnNbb3B0aW9uTmFtZSBhcyBrZXlvZiBPcHRpb25zXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHVzZSBsb3ctbGV2ZWwgb3B0aW9uIHNldHRlclxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc29ydGFibGVJbnN0YW5jZT8ub3B0aW9uKG9wdGlvbk5hbWUgYXMga2V5b2YgT3B0aW9ucywgdGhpcy5vcHRpb25zW29wdGlvbk5hbWUgYXMga2V5b2YgT3B0aW9uc10pXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiBAaW50ZXJuYWwgKi9cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnNvcnRhYmxlSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgdGhpcy5zb3J0YWJsZUluc3RhbmNlLmRlc3Ryb3koKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZSgpIHtcclxuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLnNvcnRhYmxlanNDb250YWluZXIgPyB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKHRoaXMuc29ydGFibGVqc0NvbnRhaW5lcikgOiB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudFxyXG5cclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zb3J0YWJsZUluc3RhbmNlID0gU29ydGFibGUuY3JlYXRlKGNvbnRhaW5lciwgdGhpcy5vcHRpb25zKVxyXG4gICAgICAgICAgICB0aGlzLmluaXQuZW1pdCh0aGlzLnNvcnRhYmxlSW5zdGFuY2UpXHJcbiAgICAgICAgfSwgMClcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEJpbmRpbmdzKCk6IFNvcnRhYmxlanNCaW5kaW5nczxUPiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBTb3J0YWJsZWpzQmluZGluZ3MoW10pXHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmRhdGEgaW5zdGFuY2VvZiBTb3J0YWJsZWpzQmluZGluZ3MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgU29ydGFibGVqc0JpbmRpbmdzKFt0aGlzLmRhdGFdKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldCBvcHRpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB7IC4uLnRoaXMub3B0aW9uc1dpdGhvdXRFdmVudHMsIC4uLnRoaXMub3ZlcnJpZGVuT3B0aW9ucyB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXQgb3B0aW9uc1dpdGhvdXRFdmVudHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHsgLi4uKHRoaXMuZ2xvYmFsQ29uZmlnIHx8IHt9KSwgLi4uKHRoaXMuY29uZmlnIHx8IHt9KSB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwcm94eUV2ZW50KGV2ZW50TmFtZTogc3RyaW5nLCAuLi5wYXJhbXM6IGFueVtdKSB7XHJcbiAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7IC8vIHJlLWVudGVyaW5nIHpvbmUsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vU29ydGFibGVKUy9hbmd1bGFyLXNvcnRhYmxlanMvaXNzdWVzLzExMCNpc3N1ZWNvbW1lbnQtNDA4ODc0NjAwXHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnNXaXRob3V0RXZlbnRzPy5bZXZlbnROYW1lIGFzIGtleW9mIHR5cGVvZiB0aGlzLm9wdGlvbnNXaXRob3V0RXZlbnRzXSkge1xyXG4gICAgICAgICAgICAgICAgKHRoaXMub3B0aW9uc1dpdGhvdXRFdmVudHNbZXZlbnROYW1lIGFzIGtleW9mIHR5cGVvZiB0aGlzLm9wdGlvbnNXaXRob3V0RXZlbnRzXSBhcyAoLi4ucGFyYW1zOiBhbnlbXSkgPT4gdm9pZCkoLi4ucGFyYW1zKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldCBpc0Nsb25pbmcoKSB7XHJcbiAgICAgICAgY29uc3QgZ3JvdXBPcHRpb25zID0gdGhpcy5zb3J0YWJsZUluc3RhbmNlPy5vcHRpb25zLmdyb3VwXHJcbiAgICAgICAgcmV0dXJuIGdyb3VwT3B0aW9ucyAmJiAodHlwZW9mIGdyb3VwT3B0aW9ucyAhPSAnc3RyaW5nJylcclxuICAgICAgICAgICAgPyBncm91cE9wdGlvbnMuY2hlY2tQdWxsPy4odGhpcy5zb3J0YWJsZUluc3RhbmNlISwgdGhpcy5zb3J0YWJsZUluc3RhbmNlISwgbnVsbCBhcyBhbnksIG51bGwgYXMgYW55KSA9PT0gJ2Nsb25lJ1xyXG4gICAgICAgICAgICA6IGdyb3VwT3B0aW9ucyA9PT0gJ2Nsb25lJ1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xvbmUoaXRlbTogVCk6IFQge1xyXG4gICAgICAgIC8vIGJ5IGRlZmF1bHQgcGFzcyB0aGUgaXRlbSB0aHJvdWdoLCBubyBjbG9uaW5nIHBlcmZvcm1lZFxyXG4gICAgICAgIHJldHVybiAodGhpcy5jbG9uZUZ1bmN0aW9uIHx8IChzdWJpdGVtID0+IHN1Yml0ZW0pKShpdGVtKVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0IG92ZXJyaWRlbk9wdGlvbnMoKTogT3B0aW9ucyB7XHJcbiAgICAgICAgLy8gYWx3YXlzIGludGVyY2VwdCBzdGFuZGFyZCBldmVudHMgYnV0IGFjdCBvbmx5IGluIGNhc2UgaXRlbXMgYXJlIHNldCAoYmluZGluZ0VuYWJsZWQpXHJcbiAgICAgICAgLy8gYWxsb3dzIHRvIGZvcmdldCBhYm91dCB0cmFja2luZyB0aGlzLml0ZW1zIGNoYW5nZXNcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBvbkFkZDogKGV2ZW50OiBTb3J0YWJsZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXIgPSAoaXRlbXM6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRCaW5kaW5ncygpLmluamVjdEludG9FdmVyeShldmVudC5uZXdJbmRleCEsIGl0ZW1zKVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJveHlFdmVudCgnb25BZGQnLCBldmVudClcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb3h5RXZlbnQoJ29uQWRkT3JpZ2luYWwnLCBldmVudClcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgb25SZW1vdmU6IChldmVudDogU29ydGFibGVFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYmluZGluZ3MgPSB0aGlzLmdldEJpbmRpbmdzKClcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ3MucHJvdmlkZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0Nsb25pbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnRyYW5zZmVyPy4oYmluZGluZ3MuZ2V0RnJvbUV2ZXJ5KGV2ZW50Lm9sZEluZGV4ISkubWFwKGl0ZW0gPT4gdGhpcy5jbG9uZShpdGVtKSkpXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBncmVhdCB0aGFua3MgdG8gaHR0cHM6Ly9naXRodWIuY29tL3RhdXVcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXZlbnQuaXRlbSBpcyB0aGUgb3JpZ2luYWwgaXRlbSBmcm9tIHRoZSBzb3VyY2UgbGlzdCB3aGljaCBpcyBtb3ZlZCB0byB0aGUgdGFyZ2V0IGxpc3RcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXZlbnQuY2xvbmUgaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgaXRlbSBhbmQgd2lsbCBiZSBhZGRlZCB0byBzb3VyY2UgbGlzdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBiaW5kaW5ncyBhcmUgcHJvdmlkZWQsIGFkZGluZyB0aGUgaXRlbSBkb20gZWxlbWVudCB0byB0aGUgdGFyZ2V0IGxpc3QgY2F1c2VzIGFydGlmYWN0c1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBhcyBpdCBpbnRlcmZlcmVzIHdpdGggdGhlIHJlbmRlcmluZyBwZXJmb3JtZWQgYnkgdGhlIGFuZ3VsYXIgdGVtcGxhdGUuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlZm9yZSB3ZSByZW1vdmUgaXQgaW1tZWRpYXRlbHkgYW5kIGFsc28gbW92ZSB0aGUgb3JpZ2luYWwgaXRlbSBiYWNrIHRvIHRoZSBzb3VyY2UgbGlzdC5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gKGV2ZW50IGhhbmRsZXIgbWF5IGJlIGF0dGFjaGVkIHRvIHRoZSBvcmlnaW5hbCBpdGVtIGFuZCBub3QgaXRzIGNsb25lLCB0aGVyZWZvcmUga2VlcGluZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgb3JpZ2luYWwgZG9tIG5vZGUsIGNpcmN1bXZlbnRzIHNpZGUgZWZmZWN0cyApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2hpbGQoZXZlbnQuaXRlbS5wYXJlbnROb2RlLCBldmVudC5pdGVtKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmluc2VydEJlZm9yZShldmVudC5jbG9uZS5wYXJlbnROb2RlLCBldmVudC5pdGVtLCBldmVudC5jbG9uZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZChldmVudC5jbG9uZS5wYXJlbnROb2RlLCBldmVudC5jbG9uZSlcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXI/LihiaW5kaW5ncy5leHRyYWN0RnJvbUV2ZXJ5KGV2ZW50Lm9sZEluZGV4ISkpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2UudHJhbnNmZXIgPSB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb3h5RXZlbnQoJ29uUmVtb3ZlJywgZXZlbnQpXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIG9uVXBkYXRlOiAoZXZlbnQ6IFNvcnRhYmxlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdzID0gdGhpcy5nZXRCaW5kaW5ncygpXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleGVzID0gZ2V0SW5kZXhlc0Zyb21FdmVudChldmVudClcclxuXHJcbiAgICAgICAgICAgICAgICBiaW5kaW5ncy5pbmplY3RJbnRvRXZlcnkoaW5kZXhlcy5uZXchLCBiaW5kaW5ncy5leHRyYWN0RnJvbUV2ZXJ5KGluZGV4ZXMub2xkISkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb3h5RXZlbnQoJ29uVXBkYXRlJywgZXZlbnQpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==