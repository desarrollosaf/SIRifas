import { Injectable, PLATFORM_ID, inject } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, EMPTY, tap, map, from, filter, forkJoin, switchMap, throwError, catchError, firstValueFrom } from 'rxjs';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import { LoaderErrors } from './loader-errors';
import * as i0 from "@angular/core";
export class HighlightLoader {
    constructor() {
        this.document = inject(DOCUMENT);
        this.isPlatformBrowser = isPlatformBrowser(inject(PLATFORM_ID));
        this.options = inject(HIGHLIGHT_OPTIONS, { optional: true });
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = firstValueFrom(this._ready.asObservable().pipe(filter((hljs) => !!hljs)));
        if (this.isPlatformBrowser) {
            // Check if hljs is already available
            if (this.document.defaultView['hljs']) {
                this._ready.next(this.document.defaultView['hljs']);
            }
            else {
                // Load hljs library
                this._loadLibrary().pipe(switchMap((hljs) => {
                    if (this.options?.lineNumbersLoader) {
                        // Make hljs available on window object (required for the line numbers library)
                        this.document.defaultView['hljs'] = hljs;
                        // Load line numbers library
                        return this.loadLineNumbers().pipe(tap((plugin) => {
                            plugin.activateLineNumbers();
                            this._ready.next(hljs);
                        }));
                    }
                    else {
                        this._ready.next(hljs);
                        return EMPTY;
                    }
                }), catchError((e) => {
                    console.error('[HLJS] ', e);
                    this._ready.error(e);
                    return EMPTY;
                })).subscribe();
            }
            // Load highlighting theme
            if (this.options?.themePath) {
                this.loadTheme(this.options.themePath);
            }
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    _loadLibrary() {
        if (this.options) {
            if (this.options.fullLibraryLoader && this.options.coreLibraryLoader) {
                return throwError(() => LoaderErrors.FULL_WITH_CORE_LIBRARY_IMPORTS);
            }
            if (this.options.fullLibraryLoader && this.options.languages) {
                return throwError(() => LoaderErrors.FULL_WITH_LANGUAGE_IMPORTS);
            }
            if (this.options.coreLibraryLoader && !this.options.languages) {
                return throwError(() => LoaderErrors.CORE_WITHOUT_LANGUAGE_IMPORTS);
            }
            if (!this.options.coreLibraryLoader && this.options.languages) {
                return throwError(() => LoaderErrors.LANGUAGE_WITHOUT_CORE_IMPORTS);
            }
            if (this.options.fullLibraryLoader) {
                return this.loadFullLibrary();
            }
            if (this.options.coreLibraryLoader && this.options.languages && Object.keys(this.options.languages).length) {
                return this.loadCoreLibrary().pipe(switchMap((hljs) => this._loadLanguages(hljs)));
            }
        }
        return throwError(() => LoaderErrors.NO_FULL_AND_NO_CORE_IMPORTS);
    }
    /**
     * Lazy-load highlight.js languages
     */
    _loadLanguages(hljs) {
        const languages = Object.entries(this.options.languages).map(([langName, langLoader]) => importModule(langLoader()).pipe(tap((langFunc) => hljs.registerLanguage(langName, langFunc))));
        return forkJoin(languages).pipe(map(() => hljs));
    }
    /**
     * Import highlight.js core library
     */
    loadCoreLibrary() {
        return importModule(this.options.coreLibraryLoader());
    }
    /**
     * Import highlight.js library with all languages
     */
    loadFullLibrary() {
        return importModule(this.options.fullLibraryLoader());
    }
    /**
     * Import line numbers library
     */
    loadLineNumbers() {
        return from(this.options.lineNumbersLoader());
    }
    /**
     * Reload theme styles
     */
    setTheme(path) {
        if (this.isPlatformBrowser) {
            if (this._themeLinkElement) {
                this._themeLinkElement.href = path;
            }
            else {
                this.loadTheme(path);
            }
        }
    }
    /**
     * Load theme
     */
    loadTheme(path) {
        this._themeLinkElement = this.document.createElement('link');
        this._themeLinkElement.href = path;
        this._themeLinkElement.type = 'text/css';
        this._themeLinkElement.rel = 'stylesheet';
        this._themeLinkElement.media = 'screen,print';
        this.document.head.appendChild(this._themeLinkElement);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: HighlightLoader, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: HighlightLoader, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.1", ngImport: i0, type: HighlightLoader, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [] });
/**
 * Map loader response to module object
 */
const importModule = (moduleLoader) => {
    return from(moduleLoader).pipe(filter((module) => !!module?.default), map((module) => module.default));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oaWdobGlnaHRqcy9zcmMvbGliL2hpZ2hsaWdodC5sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBRUwsZUFBZSxFQUNmLEtBQUssRUFDTCxHQUFHLEVBQ0gsR0FBRyxFQUNILElBQUksRUFDSixNQUFNLEVBQ04sUUFBUSxFQUNSLFNBQVMsRUFDVCxVQUFVLEVBQ1YsVUFBVSxFQUNWLGNBQWMsRUFDZixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxpQkFBaUIsRUFBc0IsTUFBTSxtQkFBbUIsQ0FBQztBQUUxRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7O0FBSy9DLE1BQU0sT0FBTyxlQUFlO0lBZTFCO1FBYlEsYUFBUSxHQUFhLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0QyxzQkFBaUIsR0FBWSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUNwRSxZQUFPLEdBQXVCLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXBGLGlFQUFpRTtRQUNoRCxXQUFNLEdBQTZCLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFDO1FBRTlFLFVBQUssR0FBcUIsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUMvRSxNQUFNLENBQUMsQ0FBQyxJQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDbEMs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O2tIQUFmLGVBQWUsY0FGZCxNQUFNOzsyRkFFUCxlQUFlO2tCQUgzQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7QUErSUQ7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBRyxDQUFDLFlBQTBCLEVBQW1CLEVBQUU7SUFDbkUsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUM1QixNQUFNLENBQUMsQ0FBQyxNQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQzFDLEdBQUcsQ0FBQyxDQUFDLE1BQVcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUNyQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgUExBVEZPUk1fSUQsIGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQge1xyXG4gIE9ic2VydmFibGUsXHJcbiAgQmVoYXZpb3JTdWJqZWN0LFxyXG4gIEVNUFRZLFxyXG4gIHRhcCxcclxuICBtYXAsXHJcbiAgZnJvbSxcclxuICBmaWx0ZXIsXHJcbiAgZm9ya0pvaW4sXHJcbiAgc3dpdGNoTWFwLFxyXG4gIHRocm93RXJyb3IsXHJcbiAgY2F0Y2hFcnJvcixcclxuICBmaXJzdFZhbHVlRnJvbVxyXG59IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBISUdITElHSFRfT1BUSU9OUywgSGlnaGxpZ2h0SlNPcHRpb25zIH0gZnJvbSAnLi9oaWdobGlnaHQubW9kZWwnO1xyXG5pbXBvcnQgdHlwZSB7IEhMSlNBcGkgfSBmcm9tICdoaWdobGlnaHQuanMnO1xyXG5pbXBvcnQgeyBMb2FkZXJFcnJvcnMgfSBmcm9tICcuL2xvYWRlci1lcnJvcnMnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgSGlnaGxpZ2h0TG9hZGVyIHtcclxuXHJcbiAgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQgPSBpbmplY3QoRE9DVU1FTlQpO1xyXG4gIHByaXZhdGUgaXNQbGF0Zm9ybUJyb3dzZXI6IGJvb2xlYW4gPSBpc1BsYXRmb3JtQnJvd3NlcihpbmplY3QoUExBVEZPUk1fSUQpKTtcclxuICBwcml2YXRlIG9wdGlvbnM6IEhpZ2hsaWdodEpTT3B0aW9ucyA9IGluamVjdChISUdITElHSFRfT1BUSU9OUywgeyBvcHRpb25hbDogdHJ1ZSB9KTtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBobGpzIGxpYnJhcnkgaXMgbG9hZGVkIGFuZCByZWFkeSB0byB1c2VcclxuICBwcml2YXRlIHJlYWRvbmx5IF9yZWFkeTogQmVoYXZpb3JTdWJqZWN0PEhMSlNBcGk+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxITEpTQXBpPihudWxsKTtcclxuXHJcbiAgcmVhZG9ubHkgcmVhZHk6IFByb21pc2U8SExKU0FwaT4gPSBmaXJzdFZhbHVlRnJvbSh0aGlzLl9yZWFkeS5hc09ic2VydmFibGUoKS5waXBlKFxyXG4gICAgZmlsdGVyKChobGpzOiBITEpTQXBpKSA9PiAhIWhsanMpLFxyXG4gICkpO1xyXG5cclxuICBwcml2YXRlIF90aGVtZUxpbmtFbGVtZW50OiBIVE1MTGlua0VsZW1lbnQ7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgaWYgKHRoaXMuaXNQbGF0Zm9ybUJyb3dzZXIpIHtcclxuICAgICAgLy8gQ2hlY2sgaWYgaGxqcyBpcyBhbHJlYWR5IGF2YWlsYWJsZVxyXG4gICAgICBpZiAodGhpcy5kb2N1bWVudC5kZWZhdWx0Vmlld1snaGxqcyddKSB7XHJcbiAgICAgICAgdGhpcy5fcmVhZHkubmV4dCh0aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3WydobGpzJ10pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIExvYWQgaGxqcyBsaWJyYXJ5XHJcbiAgICAgICAgdGhpcy5fbG9hZExpYnJhcnkoKS5waXBlKFxyXG4gICAgICAgICAgc3dpdGNoTWFwKChobGpzOiBITEpTQXBpKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnM/LmxpbmVOdW1iZXJzTG9hZGVyKSB7XHJcbiAgICAgICAgICAgICAgLy8gTWFrZSBobGpzIGF2YWlsYWJsZSBvbiB3aW5kb3cgb2JqZWN0IChyZXF1aXJlZCBmb3IgdGhlIGxpbmUgbnVtYmVycyBsaWJyYXJ5KVxyXG4gICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXdbJ2hsanMnXSA9IGhsanM7XHJcbiAgICAgICAgICAgICAgLy8gTG9hZCBsaW5lIG51bWJlcnMgbGlicmFyeVxyXG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvYWRMaW5lTnVtYmVycygpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICB0YXAoKHBsdWdpbjogeyBhY3RpdmF0ZUxpbmVOdW1iZXJzOiAoKSA9PiB2b2lkIH0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgcGx1Z2luLmFjdGl2YXRlTGluZU51bWJlcnMoKTtcclxuICAgICAgICAgICAgICAgICAgdGhpcy5fcmVhZHkubmV4dChobGpzKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLl9yZWFkeS5uZXh0KGhsanMpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICBjYXRjaEVycm9yKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW0hMSlNdICcsIGUpO1xyXG4gICAgICAgICAgICB0aGlzLl9yZWFkeS5lcnJvcihlKTtcclxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApLnN1YnNjcmliZSgpO1xyXG5cclxuICAgICAgfVxyXG4gICAgICAvLyBMb2FkIGhpZ2hsaWdodGluZyB0aGVtZVxyXG4gICAgICBpZiAodGhpcy5vcHRpb25zPy50aGVtZVBhdGgpIHtcclxuICAgICAgICB0aGlzLmxvYWRUaGVtZSh0aGlzLm9wdGlvbnMudGhlbWVQYXRoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTGF6eS1Mb2FkIGhpZ2hsaWdodC5qcyBsaWJyYXJ5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBfbG9hZExpYnJhcnkoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICh0aGlzLm9wdGlvbnMpIHtcclxuICAgICAgaWYgKHRoaXMub3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciAmJiB0aGlzLm9wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBMb2FkZXJFcnJvcnMuRlVMTF9XSVRIX0NPUkVfTElCUkFSWV9JTVBPUlRTKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyICYmIHRoaXMub3B0aW9ucy5sYW5ndWFnZXMpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBMb2FkZXJFcnJvcnMuRlVMTF9XSVRIX0xBTkdVQUdFX0lNUE9SVFMpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIgJiYgIXRoaXMub3B0aW9ucy5sYW5ndWFnZXMpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBMb2FkZXJFcnJvcnMuQ09SRV9XSVRIT1VUX0xBTkdVQUdFX0lNUE9SVFMpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghdGhpcy5vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyICYmIHRoaXMub3B0aW9ucy5sYW5ndWFnZXMpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcigoKSA9PiBMb2FkZXJFcnJvcnMuTEFOR1VBR0VfV0lUSE9VVF9DT1JFX0lNUE9SVFMpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sb2FkRnVsbExpYnJhcnkoKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyICYmIHRoaXMub3B0aW9ucy5sYW5ndWFnZXMgJiYgT2JqZWN0LmtleXModGhpcy5vcHRpb25zLmxhbmd1YWdlcykubGVuZ3RoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZENvcmVMaWJyYXJ5KCkucGlwZShzd2l0Y2hNYXAoKGhsanM6IEhMSlNBcGkpID0+IHRoaXMuX2xvYWRMYW5ndWFnZXMoaGxqcykpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gTG9hZGVyRXJyb3JzLk5PX0ZVTExfQU5EX05PX0NPUkVfSU1QT1JUUyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMYXp5LWxvYWQgaGlnaGxpZ2h0LmpzIGxhbmd1YWdlc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgX2xvYWRMYW5ndWFnZXMoaGxqczogSExKU0FwaSk6IE9ic2VydmFibGU8SExKU0FwaT4ge1xyXG4gICAgY29uc3QgbGFuZ3VhZ2VzOiBPYnNlcnZhYmxlPGFueT5bXSA9IE9iamVjdC5lbnRyaWVzKHRoaXMub3B0aW9ucy5sYW5ndWFnZXMpLm1hcCgoW2xhbmdOYW1lLCBsYW5nTG9hZGVyXTogW3N0cmluZywgKCkgPT4gUHJvbWlzZTxhbnk+XSkgPT5cclxuICAgICAgaW1wb3J0TW9kdWxlKGxhbmdMb2FkZXIoKSkucGlwZShcclxuICAgICAgICB0YXAoKGxhbmdGdW5jOiBhbnkpID0+IGhsanMucmVnaXN0ZXJMYW5ndWFnZShsYW5nTmFtZSwgbGFuZ0Z1bmMpKVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIGZvcmtKb2luKGxhbmd1YWdlcykucGlwZShtYXAoKCkgPT4gaGxqcykpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEltcG9ydCBoaWdobGlnaHQuanMgY29yZSBsaWJyYXJ5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2FkQ29yZUxpYnJhcnkoKTogT2JzZXJ2YWJsZTxITEpTQXBpPiB7XHJcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMub3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciEoKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGxpYnJhcnkgd2l0aCBhbGwgbGFuZ3VhZ2VzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2FkRnVsbExpYnJhcnkoKTogT2JzZXJ2YWJsZTxITEpTQXBpPiB7XHJcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMub3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciEoKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbXBvcnQgbGluZSBudW1iZXJzIGxpYnJhcnlcclxuICAgKi9cclxuICBwcml2YXRlIGxvYWRMaW5lTnVtYmVycygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIGZyb20odGhpcy5vcHRpb25zLmxpbmVOdW1iZXJzTG9hZGVyISgpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbG9hZCB0aGVtZSBzdHlsZXNcclxuICAgKi9cclxuICBzZXRUaGVtZShwYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmlzUGxhdGZvcm1Ccm93c2VyKSB7XHJcbiAgICAgIGlmICh0aGlzLl90aGVtZUxpbmtFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy5fdGhlbWVMaW5rRWxlbWVudC5ocmVmID0gcGF0aDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmxvYWRUaGVtZShwYXRoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9hZCB0aGVtZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbG9hZFRoZW1lKHBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5fdGhlbWVMaW5rRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpO1xyXG4gICAgdGhpcy5fdGhlbWVMaW5rRWxlbWVudC5ocmVmID0gcGF0aDtcclxuICAgIHRoaXMuX3RoZW1lTGlua0VsZW1lbnQudHlwZSA9ICd0ZXh0L2Nzcyc7XHJcbiAgICB0aGlzLl90aGVtZUxpbmtFbGVtZW50LnJlbCA9ICdzdHlsZXNoZWV0JztcclxuICAgIHRoaXMuX3RoZW1lTGlua0VsZW1lbnQubWVkaWEgPSAnc2NyZWVuLHByaW50JztcclxuICAgIHRoaXMuZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCh0aGlzLl90aGVtZUxpbmtFbGVtZW50KTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBNYXAgbG9hZGVyIHJlc3BvbnNlIHRvIG1vZHVsZSBvYmplY3RcclxuICovXHJcbmNvbnN0IGltcG9ydE1vZHVsZSA9IChtb2R1bGVMb2FkZXI6IFByb21pc2U8YW55Pik6IE9ic2VydmFibGU8YW55PiA9PiB7XHJcbiAgcmV0dXJuIGZyb20obW9kdWxlTG9hZGVyKS5waXBlKFxyXG4gICAgZmlsdGVyKChtb2R1bGU6IGFueSkgPT4gISFtb2R1bGU/LmRlZmF1bHQpLFxyXG4gICAgbWFwKChtb2R1bGU6IGFueSkgPT4gbW9kdWxlLmRlZmF1bHQpXHJcbiAgKTtcclxufTtcclxuIl19